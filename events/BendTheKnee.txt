namespace = bendtheknee
country_event = {
	id = bendtheknee.1
	title = "bendtheknee.1.t"
	desc = "bendtheknee.1.d"
	picture = POPE_PREACHING_eventPicture
	trigger = {
		AND = {
			OR = {
				tag = KOL
				tag = LIE
				tag = TRI
				tag = MUN
			}
			religion = waldensian
		}
		NOT = {
			has_country_flag = screw_pope
		}
		NOT = {
			has_country_flag = hail_popeman
		}
	}
	mean_time_to_happen = {
		days = 10
	}
	immediate = {
	}
	option = {
		name = "bendtheknee.1.a"
		add_stability = 1
		add_prestige = 50
		set_country_flag = screw_pope
	}
	option = {
		name = "bendtheknee.1.b"
		add_stability = -1
		add_prestige = -50
		add_treasury = 100
		change_religion = catholic
		set_country_flag = hail_popeman
	}
}

country_event = {
	id = bendtheknee.2
	title = "bendtheknee.2.t"
	desc = "bendtheknee.2.d"
	picture = POPE_PREACHING_eventPicture
	trigger = {
		AND = {
			OR = {
				tag = ENG
				tag = SCO
				tag = GBR
			}
			religion = lollard
		}
		NOT = {
			has_country_flag = screw_pope
		}
		NOT = {
			has_country_flag = hail_popeman
		}
	}
	mean_time_to_happen = {
		days = 10
	}
	immediate = {
	}
	option = {
		name = "bendtheknee.2.a"
		add_stability = 1
		add_prestige = 50
		set_country_flag = screw_pope
	}
	option = {
		name = "bendtheknee.2.b"
		add_stability = -1
		add_prestige = -50
		add_treasury = 100
		change_religion = catholic
		set_country_flag = hail_popeman
	}
}

country_event = {
	id = bendtheknee.3
	title = "bendtheknee.3.t"
	desc = "bendtheknee.3.d"
	picture = POPE_PREACHING_eventPicture
	trigger = {
		religion = catholic
		is_religion_enabled = protestant
		NOT = {
			culture_group = latin
		}
		NOT = {
			culture_group = iberian
		}
		NOT = {
			culture_group = gaelic
		}
		NOT = {
			has_country_flag = screw_pope
		}
		NOT = {
			has_country_flag = hail_popeman
		}
	}
	mean_time_to_happen = {
		months = 6
	}
	immediate = {
	}
	option = {
		name = "bendtheknee.3.a"
		add_prestige = 50
		change_religion = fraticelli
		set_country_flag = screw_pope
	}
	option = {
		name = "bendtheknee.3.b"
		add_stability = 1
		add_treasury = 100
		set_country_flag = hail_popeman
	}
}

country_event = {
	id = bendtheknee.4
	title = "bendtheknee.4.t"
	desc = "bendtheknee.4.d"
	picture = POPE_PREACHING_eventPicture
	hidden = yes
	trigger = {
		NOT = {
			is_emperor = yes
		}
		NOT = {
			is_emperor_of_china = yes
		}
		NOT = {
			has_country_flag = empire_name
		}
		NOT = {
			has_country_flag = minoa_flag
		}
		government_rank = 3
	}
	mean_time_to_happen = {
		days = 30
	}
	immediate = {
		set_country_flag = empire_name
		empire_name_effect = yes
	}
	option = {
		name = "bendtheknee.4.a"
	}
}

country_event = {
	id = bendtheknee.5
	title = "bendtheknee.5.t"
	desc = "bendtheknee.5.d"
	picture = POPE_PREACHING_eventPicture
	fire_only_once = yes
	trigger = {
		tag = HAB
	}
	mean_time_to_happen = {
		days = 3650
	}
	option = {
		name = "bendtheknee.5.a"
		hidden_effect = {
			set_hre_religion_treaty = yes
			set_hre_religion = catholic
			set_hre_religion_treaty = no
			set_hre_religion_locked = yes
			set_hre_religion_locked = no
		}
	}
}

country_event = {
	id = bendtheknee.6
	title = "bendtheknee.6.t"
	desc = "bendtheknee.6.d"
	picture = POPE_PREACHING_eventPicture
	fire_only_once = yes
	trigger = {
		NOT = {
			ai = yes
		}
		OR = {
			tag = TKT
			tag = KNI
		}
		OR = {
			IF = {
				limit = {
					tag = KNI
					NOT = {
						has_ruler = "Jean Bonpar de Lastic"
					}
				}
			}
			IF = {
				limit = {
					tag = TKT
					NOT = {
						has_ruler = "Alain de Barrau"
					}
				}
			}
		}
	}
	option = {
		name = "bendtheknee.6.a"
		IF = {
			limit = {
				tag = KNI
				TKT = {
					ai = yes
				}
			}
			inherit = TKT
		}
		IF = {
			limit = {
				tag = TKT
				KNI = {
					ai = yes
				}
			}
			inherit = KNI
		}
		IF = {
			limit = {
				tag = KNI
				TKT = {
					NOT = {
						ai = yes
					}
				}
			}
			vassalize = TKT
		}
		IF = {
			limit = {
				tag = TKT
				KNI = {
					NOT = {
						ai = yes
					}
				}
			}
			vassalize = KNI
		}
	}
}

country_event = {
	id = bendtheknee.7
	title = "bendtheknee.7.t"
	desc = "bendtheknee.7.d"
	picture = POPE_PREACHING_eventPicture
	trigger = {
		AND = {
			OR = {
				tag = TKT
				tag = KNI
				tag = TEU
				tag = LIV
			}
		}
		NOT = {
			has_country_flag = screw_pope_subject
		}
		NOT = {
			has_country_flag = hail_popeman_subject
		}
	}
	mean_time_to_happen = {
		months = 12
	}
	immediate = {
		PAP = {
			set_country_flag = pope_asks_for_subjects
		}
	}
	option = {
		name = "bendtheknee.7.a"
		set_country_flag = hail_popeman_subject
		ai_chance = {
			factor = 95
		}
	}
	option = {
		name = "bendtheknee.7.b"
		set_country_flag = screw_pope_subject
		ai_chance = {
			factor = 5
		}
	}
}

country_event = {
	id = bendtheknee.8
	title = "bendtheknee.8.t"
	desc = "bendtheknee.8.d"
	picture = POPE_PREACHING_eventPicture
	fire_only_once = yes
	trigger = {
		tag = PAP
		has_country_flag = pope_asks_for_subjects
	}
	mean_time_to_happen = {
		months = 120
	}
	option = {
		name = "bendtheknee.8.a"
		IF = {
			limit = {
				KNI = {
					has_country_flag = hail_popeman_subject
				}
			}
			create_subject = {
				subject_type = papal_vassal
				subject = KNI
			}
		}
		ELSE_IF = {
			limit = {
				KNI = {
					has_country_flag = screw_pope_subject
				}
			}
			excommunicate = KNI
		}
		IF = {
			limit = {
				LIV = {
					has_country_flag = hail_popeman_subject
				}
			}
			create_subject = {
				subject_type = papal_vassal
				subject = LIV
			}
		}
		ELSE_IF = {
			limit = {
				KNI = {
					has_country_flag = screw_pope_subject
				}
			}
			excommunicate = LIV
		}
		IF = {
			limit = {
				TEU = {
					has_country_flag = hail_popeman_subject
				}
			}
			create_subject = {
				subject_type = papal_vassal
				subject = TEU
			}
		}
		ELSE_IF = {
			limit = {
				TEU = {
					has_country_flag = screw_pope_subject
				}
			}
			excommunicate = TEU
		}
		IF = {
			limit = {
				TKT = {
					has_country_flag = hail_popeman_subject
				}
			}
			create_subject = {
				subject_type = papal_vassal
				subject = TKT
			}
		}
		ELSE_IF = {
			limit = {
				TKT = {
					has_country_flag = screw_pope_subject
				}
			}
			excommunicate = TKT
		}
	}
}

# The DYNASTYNAME theocratic_autocracy has fallen!
province_event = {
	id = bendtheknee.9
	title = "bendtheknee.9.t"
	picture = COURT_eventPicture
	major = yes
	is_triggered_only = yes
	desc = {
		trigger = {
			owner = {
				has_reform = theocratic_autocracy
			}
			FROM = {
				has_reform = theocratic_autocracy
			}
		}
		desc = bendtheknee.9.da
	}
	desc = {
		trigger = {
			owner = {
				has_reform = theocratic_autocracy
			}
			FROM = {
				NOT = {
					has_reform = theocratic_autocracy
				}
			}
		}
		desc = bendtheknee.9.db
	}
	desc = {
		trigger = {
			owner = {
				NOT = {
					has_reform = theocratic_autocracy
				}
			}
		}
		desc = bendtheknee.9.dc
	}
	trigger = {
		# OBS! These checks are also hard coded in WouldBecometheocratic_autocracyIfTaking() for AI and interface reasons. Change code too if this trigger changes.
		province_id = 151
		#owner = {
		#	OR = {
		#		has_reform = grk_demo
		#		has_reform = oligarchic_reform
		#	}
		#}
	}
	immediate = {
		#Save new owner as theocratic_autocracy if valid
		hidden_effect = {
			owner = {
				if = {
					limit = {
						has_reform = grk_demo
						culture_group = byzantine
					}
					add_core = 151
					set_capital = 151
					#There was a bug, which made it possible that the new theocratic_autocracy remained a grk_demo despite having Constantinople
					#I couldn't replicate it though, so I hope the line below might fix it - in the worst case it does nothing
					grant_independence = yes
					change_government_to_monarchy = yes
					add_government_reform = theocratic_autocracy
					add_government_reform = theocratic_autocracy
					save_event_target_as = new_theocratic_autocracy
				}
			}
		}
		#Handle grk_demo transfer
		hidden_effect = {
			#Case - new owner is the new theocratic_autocracy, previous still lives -> all grk_demos get transferred from the previous to the new one
			if = {
				limit = {
					FROM = {
						exists = yes
					}
					owner = {
						has_reform = theocratic_autocracy
					}
					FROM = {
						has_reform = theocratic_autocracy
					}
				}
				#Degrade the previous theocratic_autocracy to grk_demo level
				FROM = {
					every_subject_country = {
						limit = {
							is_subject_of_type = greek_vassal
						}
						set_country_flag = tobe_grk_demo_of_new_theocratic_autocracy
						grant_independence = yes
					}
					event_target:new_theocratic_autocracy = {
						create_subject = {
							subject_type = greek_vassal
							subject = FROM
						}
					}
					set_government_rank = 1
					add_government_reform = grk_demo
				}
				#Vassalize all of the former grk_demos
				#NOTE: originally, it was intended that grk_demos, who are at war with the theocratic_autocracy, should not be vassalized
				every_country = {
					limit = {
						has_country_flag = tobe_grk_demo_of_new_theocratic_autocracy
					}
					event_target:new_theocratic_autocracy = {
						create_subject = {
							subject_type = greek_vassal
							subject = PREV
						}
					}
				}
				owner = {
					country_event = {
						id = bendtheknee.12
						days = 1
					}
				}
			}
			#Case - new owner is not the new theocratic_autocracy, previous still lives -> all grk_demos get free
			if = {
				limit = {
					FROM = {
						exists = yes
					}
					NOT = {
						owner = {
							has_reform = theocratic_autocracy
						}
					}
					FROM = {
						has_reform = theocratic_autocracy
					}
				}
				FROM = {
					every_subject_country = {
						limit = {
							is_subject_of_type = greek_vassal
						}
						grant_independence = yes
						if = {
							limit = {
								has_reform = grk_demo
							}
							add_government_reform = oligarchic_republic
						}
					}
					add_government_reform = oligarchic_republic
				}
			}
			#Case - new owner is theocratic_autocracy, previous theocratic_autocracy is dead -> all grk_demos become subjects of the new theocratic_autocracy
			if = {
				limit = {
					NOT = {
						FROM = {
							exists = yes
						}
					}
					owner = {
						has_reform = theocratic_autocracy
					}
				}
				every_country = {
					limit = {
						has_reform = grk_demo
						NOT = {
							war_with = event_target:new_theocratic_autocracy
						}
					}
					event_target:new_theocratic_autocracy = {
						create_subject = {
							subject_type = greek_vassal
							subject = PREV
						}
					}
				}
				every_country = {
					limit = {
						has_reform = grk_demo
						war_with = event_target:new_theocratic_autocracy
					}
					add_government_reform = oligarchic_republic
				}
			}
			#Case - new owner is not the new theocratic_autocracy, previous one is dead -> all former grk_demos become independent grk_demo
			if = {
				limit = {
					NOT = {
						FROM = {
							exists = yes
						}
					}
					NOT = {
						owner = {
							has_reform = theocratic_autocracy
						}
					}
				}
				every_country = {
					limit = {
						has_reform = grk_demo
					}
					overlord = {
						free_vassal = PREV
					}
					add_government_reform = oligarchic_republic
				}
			}
		}
		#Catch all remaining grk_demos and let them free
		hidden_effect = {
			if = {
				limit = {
					any_country = {
						is_subject_of_type = greek_vassal
						NOT = {
							overlord = {
								has_reform = theocratic_autocracy
							}
						}
					}
				}
				every_country = {
					limit = {
						is_subject_of_type = greek_vassal
						NOT = {
							overlord = {
								has_reform = theocratic_autocracy
							}
						}
					}
					overlord = {
						free_vassal = PREV
					}
					if = {
						limit = {
							has_reform = grk_demo
						}
						remove_government_reform = grk_demo
						add_government_reform = oligarchic_republic
					}
				}
			}
		}
	}
	option = {
		name = "japan.EVTOPTA1"
		if = {
			limit = {
				owner = {
					has_reform = grk_demo
				}
			}
			custom_tooltip = claiming_the_theocratic_autocracy_tooltip
		}
		if = {
			limit = {
				NOT = {
					owner = {
						has_reform = theocratic_autocracy
					}
				}
			}
			owner = {
				if = {
					limit = {
						NOT = {
							has_country_flag = destroyed_theocratic_autocracy
						}
					}
					add_prestige = 20
					add_adm_power = 50
					add_dip_power = 50
					add_mil_power = 50
					set_country_flag = destroyed_theocratic_autocracy
				}
			}
		}
	}
}

# I couldn't actually find a way to get this event to fire from the last one, so I assume that the NOT = { exists = FROM } bit is actually unused. But just in case I missed something, it seems better to add this anyway.
# New theocratic_autocracy - join or not?
country_event = {
	id = bendtheknee.10
	title = bendtheknee.10.name
	desc = bendtheknee.10.desc
	picture = COURT_eventPicture
	is_triggered_only = yes
	option = {
		#be a grk_demo
		name = bendtheknee.10.A
		event_target:new_theocratic_autocracy = {
			create_subject = {
				subject_type = greek_vassal
				subject = ROOT
			}
		}
		ai_chance = {
			factor = 1
		}
	}
	option = {
		#don't be a grk_demo
		name = bendtheknee.10.B
		event_target:new_theocratic_autocracy = {
			add_opinion = {
				who = root
				modifier = opinion_defy_new_theocratic_autocracy
			}
			country_event = {
				id = bendtheknee.11
				days = 1
			}
			add_casus_belli = {
				target = ROOT
				type = cb_vassalize_mission
				months = 300
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 1
				NOT = {
					num_of_cities = 10
				}
			}
		}
	}
}

country_event = {
	id = bendtheknee.11
	title = bendtheknee.11.name
	desc = bendtheknee.11.desc
	picture = COURT_eventPicture
	is_triggered_only = yes
	option = {
		#be a grk_demo
		name = bendtheknee.11.opt
		event_target:new_theocratic_autocracy = {
			create_subject = {
				subject_type = greek_vassal
				subject = ROOT
			}
		}
	}
}

country_event = {
	id = bendtheknee.12
	title = bendtheknee.12.t
	desc = bendtheknee.12.desc
	picture = COURT_eventPicture
	is_triggered_only = yes
	hidden = yes
	option = {
		#We don't follow a bully
		name = bendtheknee.12.a
		every_country = {
			limit = {
				has_country_flag = tobe_grk_demo_of_new_theocratic_autocracy
			}
			clr_country_flag = tobe_grk_demo_of_new_theocratic_autocracy
			if = {
				limit = {
					war_with = ROOT
					is_subject_of = ROOT
				}
				grant_independence = yes
				if = {
					limit = {
						has_reform = grk_demo
					}
					add_government_reform = oligarchic_republic
				}
				#The Shogun should be able to retake his defected grk_demos
				reverse_add_casus_belli = {
					target = ROOT
					type = cb_vassalize_mission
					months = 300
				}
			}
		}
		ai_chance = {
			factor = 1
		}
	}
}

country_event = {
	id = bendtheknee.13
	title = "bendtheknee.13.t"
	desc = "bendtheknee.13.d"
	picture = POPE_PREACHING_eventPicture
	trigger = {
		AND = {
			culture_group = byzantine
			NOT = {
				has_reform = theocratic_autocracy
			}
		}
		NOT = {
			has_country_flag = screw_hegemon
		}
		NOT = {
			has_country_flag = hail_hegemon
		}
	}
	mean_time_to_happen = {
		days = 1
	}
	immediate = {
		BYZ = {
			set_country_flag = byz_asks_for_subjects
		}
	}
	option = {
		name = "bendtheknee.13.a"
		set_country_flag = hail_hegemon
		ai_chance = {
			factor = 95
		}
	}
	option = {
		name = "bendtheknee.7.b"
		set_country_flag = screw_hegemon
		ai_chance = {
			factor = 5
		}
	}
}

country_event = {
	id = bendtheknee.14
	title = "bendtheknee.14.t"
	desc = "bendtheknee.14.d"
	picture = POPE_PREACHING_eventPicture
	fire_only_once = yes
	trigger = {
		has_country_flag = byz_asks_for_subjects
	}
	mean_time_to_happen = {
		months = 12
	}
	option = {
		name = "bendtheknee.14.a"
		IF = {
			limit = {
				AEG = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = AEG
			}
		}
		ELSE_IF = {
			limit = {
				AEG = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				CEP = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = CEP
			}
		}
		ELSE_IF = {
			limit = {
				CEP = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				CRT = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = CRT
			}
		}
		ELSE_IF = {
			limit = {
				CRT = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				EPI = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = EPI
			}
		}
		ELSE_IF = {
			limit = {
				EPI = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				MAC = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = MAC
			}
		}
		ELSE_IF = {
			limit = {
				MAC = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				MOE = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = MOE
			}
		}
		ELSE_IF = {
			limit = {
				MOE = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				NAX = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = NAX
			}
		}
		ELSE_IF = {
			limit = {
				NAX = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				CND = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = CND
			}
		}
		ELSE_IF = {
			limit = {
				CND = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
		IF = {
			limit = {
				TRE = {
					has_country_flag = hail_hegemon
				}
			}
			create_subject = {
				subject_type = greek_vassal
				subject = TRE
			}
		}
		ELSE_IF = {
			limit = {
				TRE = {
					has_country_flag = screw_hegemon
				}
			}
			add_stability = -1
		}
	}
}
